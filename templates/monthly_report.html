<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>月報・分析 - {{ year }}年{{ month }}月</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Yu Gothic', '游ゴシック', 'Hiragino Kaku Gothic ProN', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f9f9f9;
            color: #333;
            font-size: 18px;
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 980px;
            margin: 44px auto 0 auto;
            background: #fff;
            border-radius: 14px;
            box-shadow: 0 4px 20px rgba(30, 30, 60, 0.08);
            padding: 48px 42px 38px 42px;
        }
        h1 {
            text-align: center;
            color: #222;
            font-size: 2.15em;
            font-weight: 400;
            margin-bottom: 30px;
            letter-spacing: 1px;
        }
        h2 {
            text-align: left;
            font-size: 1.16em;
            color: #007bff;
            font-weight: 500;
            border-left: 4px solid #007bff;
            padding-left: 13px;
            margin: 38px 0 16px 0;
            background: linear-gradient(90deg, #eaf3ff 0 80%, transparent 100%);
        }
        h3 {
            font-size: 1.05em;
            color: #555;
            font-weight: 500;
            margin-bottom: 12px;
        }
        form {
            text-align: center;
            margin-bottom: 32px;
        }
        select {
            font-size: 1em;
            padding: 10px 14px;
            border: 1px solid #bbb;
            border-radius: 5px;
            margin: 0 4px 0 0;
            background: #fafbfc;
        }
        button[type="submit"] {
            background-color: #007bff;
            color: #fff;
            font-size: 1.05em;
            padding: 10px 28px;
            border: none;
            border-radius: 7px;
            cursor: pointer;
            font-weight: 600;
            margin-left: 7px;
            transition: background 0.22s;
        }
        button[type="submit"]:hover {
            background: #0056b3;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 36px;
            background: #fcfcfc;
            border-radius: 9px;
            overflow: hidden;
            box-shadow: 0 1px 4px 0 rgba(0,0,0,0.03);
        }
        th, td {
            border: 1px solid #e0e0e0;
            padding: 13px 12px;
            text-align: right;
            font-size: 1.06em;
        }
        th {
            background: #f5f5f5;
            color: #444;
            font-weight: normal;
            text-align: center;
        }
        /* カテゴリ見出し用のスタイルを追加 */
        .group-header th {
            background-color: #f0f4f8;
            text-align: left;
            padding-left: 1em;
            font-weight: 500;
            color: #334;
        }
        .chart-container {
            width: 95%;
            max-width: 700px;
            margin: 0 auto 38px auto;
            background: #f8fafc;
            border-radius: 12px;
            padding: 18px 16px 12px 16px;
            box-shadow: 0 2px 8px 0 rgba(30, 30, 60, 0.03);
        }
        .back-link {
            display: block;
            text-align: left;
            margin-top: 38px;
            color: #007bff;
            text-decoration: none;
            font-size: 1.1em;
            transition: color 0.18s;
        }
        .back-link:hover {
            color: #003a80;
            text-decoration: underline;
        }
        @media (max-width: 700px) {
            .container { padding: 14px 2vw 14px 2vw; }
            .chart-container { width: 100%; padding: 8px 2vw; }
            table th, table td { font-size: 1em; padding: 8px 4px; }
        }
    </style>
</head>
<body>
<div class="container">
    <h1>月報・分析レポート</h1>
    <form method="post">
        <select name="year">
            {% for y in year_options %}
                <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }}年</option>
            {% endfor %}
        </select>
        <select name="month">
            {% for m in range(1, 13) %}
                <option value="{{ m }}" {% if m == month %}selected{% endif %}>{{ m }}月</option>
            {% endfor %}
        </select>
        <button type="submit">表示</button>
    </form>
    
    <h2>{{ year }}年{{ month }}月 サマリー</h2>
    <table>
        <thead>
            <tr>
                <th>項目</th>
                <th>{{ year }}年{{ month }}月</th>
                <th>{{ year - 1 }}年{{ month }}月</th>
                <th>前年同月比</th>
            </tr>
        </thead>
        <tbody>
            {% if current_data and last_year_data %}
            
            <tr class="group-header">
                <th colspan="4">■ 全体サマリー</th>
            </tr>
            <tr>
                <th>総患者数</th>
                <td>{{ "{:,.0f}".format(current_data.total_patients) }} 人</td>
                <td>{{ "{:,.0f}".format(last_year_data.total_patients) }} 人</td>
                <td>
                    {% if last_year_data.total_patients > 0 %}
                        {{ "{:.1%}".format(current_data.total_patients / last_year_data.total_patients) }}
                    {% else %} - {% endif %}
                </td>
            </tr>
            <tr>
                <th>営業日数</th>
                <td>{{ current_data.business_days }} 日</td>
                <td>{{ last_year_data.business_days }} 日</td>
                <td>
                    {% if last_year_data.business_days > 0 %}
                        {{ "{:.1%}".format(current_data.business_days / last_year_data.business_days) }}
                    {% else %} - {% endif %}
                </td>
            </tr>
            <tr>
                <th>一日平均患者数</th>
                <td>{{ "{:,.1f}".format(current_data.avg_daily_patients) }} 人</td>
                <td>{{ "{:,.1f}".format(last_year_data.avg_daily_patients) }} 人</td>
                <td>
                    {% if last_year_data.avg_daily_patients > 0 %}
                        {{ "{:.1%}".format(current_data.avg_daily_patients / last_year_data.avg_daily_patients) }}
                    {% else %} - {% endif %}
                </td>
            </tr>
            <tr>
                <th>一日平均初診率</th>
                <td>{{ "{:,.1f}".format(current_data.new_patient_rate) }} %</td>
                <td>{{ "{:,.1f}".format(last_year_data.new_patient_rate) }} %</td>
                <td>-</td>
            </tr>

            <tr class="group-header">
                <th colspan="4">■ 保険点数</th>
            </tr>
            <tr>
                <th>総保険点数</th>
                <td>{{ "{:,.0f}".format(current_data.total_points) }} 点</td>
                <td>{{ "{:,.0f}".format(last_year_data.total_points) }} 点</td>
                <td>
                    {% if last_year_data.total_points > 0 %}
                        {{ "{:.1%}".format(current_data.total_points / last_year_data.total_points) }}
                    {% else %} - {% endif %}
                </td>
            </tr>
            <tr>
                <th>平均単価</th>
                <td>{{ "{:,.0f}".format(current_data.avg_price) }} 円</td>
                <td>{{ "{:,.0f}".format(last_year_data.avg_price) }} 円</td>
                <td>
                    {% if last_year_data.avg_price > 0 %}
                        {{ "{:.1%}".format(current_data.avg_price / last_year_data.avg_price) }}
                    {% else %} - {% endif %}
                </td>
            </tr>

            <tr class="group-header">
                <th colspan="4">■ 主要検査・処置</th>
            </tr>
            <tr>
                <th>胃カメラ</th>
                <td>{{ "{:,.0f}".format(current_data['胃カメラ']) }} 件</td>
                <td>{{ "{:,.0f}".format(last_year_data['胃カメラ']) }} 件</td>
                <td>
                    {% if last_year_data['胃カメラ'] > 0 %}
                        {{ "{:.1%}".format(current_data['胃カメラ'] / last_year_data['胃カメラ']) }}
                    {% else %} - {% endif %}
                </td>
            </tr>
            <tr>
                <th>大腸カメラ（ポリペクなし）</th>
                <td>{{ "{:,.0f}".format(current_data['大腸カメラ（ポリペクなし）']) }} 件</td>
                <td>{{ "{:,.0f}".format(last_year_data['大腸カメラ（ポリペクなし）']) }} 件</td>
                <td>
                    {% if last_year_data['大腸カメラ（ポリペクなし）'] > 0 %}
                        {{ "{:.1%}".format(current_data['大腸カメラ（ポリペクなし）'] / last_year_data['大腸カメラ（ポリペクなし）']) }}
                    {% else %} - {% endif %}
                </td>
            </tr>
            <tr>
                <th>大腸カメラ（ポリペクあり）</th>
                <td>{{ "{:,.0f}".format(current_data['大腸カメラ（ポリペクあり）']) }} 件</td>
                <td>{{ "{:,.0f}".format(last_year_data['大腸カメラ（ポリペクあり）']) }} 件</td>
                <td>
                    {% if last_year_data['大腸カメラ（ポリペクあり）'] > 0 %}
                        {{ "{:.1%}".format(current_data['大腸カメラ（ポリペクあり）'] / last_year_data['大腸カメラ（ポリペクあり）']) }}
                    {% else %} - {% endif %}
                </td>
            </tr>
            <tr>
                <th>インフルエンザワクチン</th>
                <td>{{ "{:,.0f}".format(current_data['インフルエンザワクチン']) }} 件</td>
                <td>{{ "{:,.0f}".format(last_year_data['インフルエンザワクチン']) }} 件</td>
                <td>
                    {% if last_year_data['インフルエンザワクチン'] > 0 %}
                        {{ "{:.1%}".format(current_data['インフルエンザワクチン'] / last_year_data['インフルエンザワクチン']) }}
                    {% else %} - {% endif %}
                </td>
            </tr>
            <tr>
                <th>健診（自治体）</th>
                <td>{{ "{:,.0f}".format(current_data['健診（自治体）']) }} 件</td>
                <td>{{ "{:,.0f}".format(last_year_data['健診（自治体）']) }} 件</td>
                <td>
                    {% if last_year_data['健診（自治体）'] > 0 %}
                        {{ "{:.1%}".format(current_data['健診（自治体）'] / last_year_data['健診（自治体）']) }}
                    {% else %} - {% endif %}
                </td>
            </tr>

            {% else %}
            <tr>
                <td colspan="4">データがありません。</td>
            </tr>
            {% endif %}
        </tbody>
    </table>

    <h2>日次推移グラフ</h2>
    <div class="chart-container">
        <h3>売上推移</h3>
        <canvas id="salesChart"></canvas>
    </div>
    <div class="chart-container">
        <h3>患者数推移</h3>
        <canvas id="patientsChart"></canvas>
    </div>
    <a href="{{ url_for('index') }}" class="back-link">← カレンダーに戻る</a>
</div>
<script>
    // Flaskから渡されたデータをJavaScript変数に変換
    const trendData = {{ trend_data | tojson }};
    // 1. 売上推移グラフ
    const salesCtx = document.getElementById('salesChart').getContext('2d');
    const salesChart = new Chart(salesCtx, {
        type: 'line',
        data: {
            labels: trendData.days,
            datasets: [{
                label: '日次売上 (円)',
                data: trendData.sales,
                borderColor: 'rgba(75, 192, 192, 1)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                fill: true,
                tension: 0.1
            }]
        }
    });
    // 2. 患者数推移グラフ
    const patientsCtx = document.getElementById('patientsChart').getContext('2d');
    const patientsChart = new Chart(patientsCtx, {
        type: 'bar',
        data: {
            labels: trendData.days,
            datasets: [{
                label: '日次患者数 (人)',
                data: trendData.patients,
                borderColor: 'rgba(255, 99, 132, 1)',
                backgroundColor: 'rgba(255, 99, 132, 0.5)',
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
</script>
</body>
</html>